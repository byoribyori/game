<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      background-color: #cbe7f0;
    }

    h1 {
      text-align: center;
      font-size: 50px;
      margin: 15px 0;
    }

    .select {
      display: flex;
      width: 500px;
      height: 60px;
      margin: auto;
      font-size: 35px;
    }

    .select>div {
      display: inline-block;
      width: 50%;
      text-align: center;
      line-height: 60px;
    }

    .select>div[data-check="T"] {
      text-decoration-color: black;
      text-decoration-line: underline;
      text-decoration-style: double;
      text-decoration-thickness: 2px;
      font-weight: bold;
    }

    form {
      width: 360px;
      margin: auto;
      display: flex;
    }

    #player1 {
      margin-top: 40px;
    }

    div[id^="player"] {
      font-size: 30px;
      text-align: center;
    }

    input[type="radio"] {
      display: none;
    }

    #form2 {
      margin-top: 40px;
    }

    label {
      display: inline-block;
      width: 40px;
      height: 40px;
      border: solid 10px #cbe7f0;
    }

    input[type="radio"]:checked+label {
      width: 60px;
      height: 60px;
      border: none;
    }

    form>label:nth-child(2) {
      background-color: red;
    }

    form>label:nth-child(4) {
      background-color: #4040ff;
    }

    form>label:nth-child(6) {
      background-color: yellow;
    }

    form>label:nth-child(8) {
      background-color: green;
    }

    form>label:nth-child(10) {
      background-color: #ff96cf;
    }

    form>label:nth-child(12) {
      background-color: black;
    }

    #link{
      width: 360px;
      margin: auto;
      height: 30px;
    }

    a{
      float: right;
      font-size: 28px;
      color: #03a2ff;
      line-height: 30px;
      height: 30px;
    }

    #start_button{
      display: block;
    border: none;
    margin: auto;
    margin-top: 40px;
    width: 230px;
    height: 70px;
    border-radius: 45% 0;
    background-color: #fffae8;
    font-size: 45px;
    cursor: pointer;
    padding: 0;
    }

    #start{
      display: inline-block;
    background: linear-gradient(90deg, red 0%,#4040ff 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    }

    #board {
      margin: 150px auto 0 auto;
      border: solid black 3px;
      border-top: none;
      border-spacing: 0;
      background-color: rgb(202 202 202)
    }

    tr:nth-child(even)>td:nth-child(even) {
      background-color: #ebebeb;
    }

    tr:nth-child(odd)>td:nth-child(odd) {
      background-color: #ebebeb;
    }

    td {
      width: 110px;
      height: 110px;
      border: black solid 1px;
      border-bottom: none;
      border-top: none;
      padding: 0;
    }

    .piece {
      width: 110px;
      height: 110px;
      border-radius: 50%;
      background-color: red;
      position: absolute;
      transition: top 0.5s;
      transition-timing-function: cubic-bezier(0.4, 0, 1, 0.9);
      transition-timing-function: linear;
    }

    img {
      position: absolute;
      width: 60px;
      height: 70px;
    }

    @media screen and (max-width:700px) {
      h1 {
        font-size: 9vw;
        margin: 0;
      }

      .select {
        width: 95%;
        font-size: 6vw;
      }

      #player1 {
        margin-top: 0;
      }

      form {
        width: 66vw;
      }

      #form2{
        margin-top: 6vw;
      }

      label {
        width: 7vw;
        height: 7vw;
        border: solid 2vw #cbe7f0;
      }

      input[type="radio"]:checked+label {
        width: 11vw;
        height: 11vw;
        border: none;
      }

      div[id^="player"] {
        font-size: 6vw;
      }

      #link{
        width: 66vw;
        height: 7vw;
      }

      a{
        height: 7vw;
        line-height: 7vw;
        font-size: 5vw;
      }

      #start_button{
        margin-top: 4vw;
        width: 40vw;
    height: 12vw;
    font-size: 8vw;
      }
    }

    @media screen and (max-width:800px) {

      td,
      .piece {
        width: 13vw;
        height: 13vw;
      }

      img {
        width: 7vw;
        height: 9vw;
      }
    }
  </style>

  <title>色並べ</title>
</head>

<body>
  <div id="area">
    <h1>色並べ</h1>

    <div class="select">
      <div class="num" data-check="T">1人で 対COM</div>
      <div class="num">2人で</div>
    </div>
    <div class="select" id="turn">
      <div class="turn" data-check="T">先攻</div>
      <div class="turn">後攻</div>
    </div>

    <div id="player1">1P</div>
    <form id="form1">
      <input type="radio" name="color1" id="red1" value="red" checked>
      <label for="red1"></label>
      <input type="radio" name="color1" id="blue1" value="#4040ff">
      <label for="blue1"></label>
      <input type="radio" name="color1" id="yellow1" value="yellow">
      <label for="yellow1"></label>
      <input type="radio" name="color1" id="green1" value="green">
      <label for="green1"></label>
      <input type="radio" name="color1" id="pink1" value="#ff96cf">
      <label for="pink1"></label>
      <input type="radio" name="color1" id="black1" value="black">
      <label for="black1"></label>
    </form>
    <form id="form2">
      <input type="radio" name="color2" id="red2" value="red">
      <label for="red2"></label>
      <input type="radio" name="color2" id="blue2" value="#4040ff">
      <label for="blue2"></label>
      <input type="radio" name="color2" id="yellow2" value="yellow">
      <label for="yellow2"></label>
      <input type="radio" name="color2" id="green2" value="green">
      <label for="green2"></label>
      <input type="radio" name="color2" id="pink2" value="#ff96cf">
      <label for="pink2"></label>
      <input type="radio" name="color2" id="black2" value="black" checked>
      <label for="black2"></label>
    </form>
    <div id="player2">COM</div>

    <div id="link">
      <a href="set_color.html" target="_blank" rel="noopener noreferrer">設定</a>
    </div>

    <button id="start_button"><span id="start">START</span></button>
  </div>

  <div id="arrow"></div>

  <style id="opacity">
    #turn {
      opacity: 1;
    }
  </style>
  <script>

    const body = document.getElementsByTagName('body')[0];
    const start_button = document.getElementById('start_button');
    const area = document.getElementById('area');
    const num = area.getElementsByClassName('num');
    const turn = area.getElementsByClassName('turn');
    const opacity = document.getElementById('opacity');
    let data = [];
    let position = [];
    let color = [null, 'green', 'black'];
    const reach_pattern = ['1110', '1101', '1011', '0111', '2220', '2202', '2022', '0222'];//リーチのパターン
    let one = true, player = 1, click = false, size, game_speed = 600;
    //一人プレイか,手番,クリック不可,1マスの大きさ,ゲームのスピード

    num[0].onclick = () => {
      if (one) return;
      num[0].dataset.check = "T";
      num[1].dataset.check = "";
      turn[0].dataset.check = "T";
      opacity.innerHTML = `#turn {
      opacity: 1;
      }`;
      document.getElementById('player2').innerText = "COM";
      one = true;
      player = 1;
    }
    num[1].onclick = () => {
      if (!one) return;
      num[1].dataset.check = "T";
      num[0].dataset.check = "";
      turn[0].dataset.check = "";
      turn[1].dataset.check = "";
      opacity.innerHTML = `#turn {
      opacity: 0.2;
      }`;
      document.getElementById('player2').innerText = "2P";
      one = false;
    }
    turn[0].onclick = () => {
      if (!one || player == 1) return;
      turn[0].dataset.check = "T";
      turn[1].dataset.check = "";
      player = 1;
    }
    turn[1].onclick = () => {
      if (!one || player == 2) return;
      turn[1].dataset.check = "T";
      turn[0].dataset.check = "";
      player = 2;
    }

    start_button.onclick = () => {

      color[1] = document.getElementById('form1').elements['color1'].value;//選択された色
      color[2] = document.getElementById('form2').elements['color2'].value;

      if (color[1] == color[2]) {
        alert('色が同じです');
        return;
      }

      if (!one) player = 1;
      area.innerHTML = '';
      let table = document.createElement('table');//盤面作成
      table.id = "board";
      for (let i = 0; i < 6; i++) {
        data.push([]);
        let tr = document.createElement('tr');
        for (let j = 0; j < 7; j++) {
          data[i].push(0);
          let td = document.createElement('td');
          td.id = `_${i}_${j}`;
          tr.appendChild(td);
        }
        table.appendChild(tr);
      }
      area.appendChild(table);

      size = document.getElementById('_0_0').getClientRects()[0].height;
      const margin = size == 110 ? 25 : (size - document.getElementsByTagName('html')[0].getClientRects()[0].width * 0.07) / 2;

      const arrow = document.getElementById('arrow');
      for (let i = 0; i < 7; i++) {
        let p = document.getElementById(`_5_${i}`);
        p = p.getClientRects()[0];
        position.push(p.left + 1);
        if (i == 6) position.push(p.top)

        arrow.innerHTML += `<img src="https://user-images.githubusercontent.com/42292029/235413421-43811d5b-895c-4713-8013-1fb4082b5c31.png" 
        alt="矢印" id="arrow${i}" style="top:${p.top - size * 6}px;
        left:${p.left + margin}px">`;
      }

      for (let i = 0; i < 7; i++) {
        document.getElementById(`arrow${i}`).onclick = () => {
          if (!click) return;
          put(i, player);
        }
      }

      if (player == 1) {
        click = true;
      } else {
        setTimeout(() => {
          put(3, 2);
        }, 1000);
      }
    }

    let put_height = [5, 5, 5, 5, 5, 5, 5];//置かれる場所
    const put = (place) => {//コマを落とす(列,手番)
      if (one && player == 2) //('----COM思考終了----');
      //(`%c${put_height[place]}  ${place}`, `color:${color[player]};font-size:1.5em`)
      click = false;
      data[put_height[place]][place] = player;
      let piece = document.createElement('div');//コマを作成
      piece.className = 'piece';
      piece.style.backgroundColor = color[player];
      piece.style.top = position[7] - size * 6 + 'px';
      piece.style.left = position[place] + 'px';
      body.appendChild(piece);//コマを表示
      setTimeout(() => {
        piece.style.top = position[7] - (5 - put_height[place]) * size + 'px';
        if (put_height[place] == 0) {//6個積んだら終わり
          document.getElementById(`arrow${place}`).remove();
          CAN.splice(CAN.indexOf(place), 1);
        }
        setTimeout(() => {
          if (reach[player].indexOf(`${put_height[place]}${place}`) > -1) {//リーチしているところに置いたら勝利
            win(player);
            return;
          } else if (reach[player % 2 + 1].indexOf(`${put_height[place]}${place}`) > -1) {//相手のリーチをなくす
            reach[player % 2 + 1].splice(reach[player % 2 + 1].indexOf(`${put_height[place]}${place}`), 1);
          }
          check_reach(place);
          put_height[place]--;
          player = player == 1 ? 2 : 1;//手番交代
          if (one && player == 2) {
            click = false;
            com();
          } else {
            click = true;
          }
        }, game_speed);
      }, 100)
    }

    let reach = [null, [], []];
    const check_reach = (p) => {

      let h = put_height[p];
      if (0 < h && h < 4 && data[h + 1][p] == player && data[h + 2][p] == player //縦に3つあるか 
        && reach[player].indexOf(`${h - 1}${p}`) == -1) {//被っていなければ追加
        reach[player].push(`${h - 1}${p}`);
      }

      const way = [[0, 1], [1, 1], [-1, 1]];//横,斜め,斜め

      a: for (let i = 0; i < 3; i++) {//3方向
        let w = way[i];

        b: for (let j = 0; j < 4; j++) {//1方向最大4パターン
          let c = [h - w[0] * j, p - w[1] * j];//チェックする場所
          if (c[0] > 5 || c[0] < 0 || c[1] < 0) continue a;//盤外なら終わり
          let r = '';//空のマス

          for (let l = 0; l < 4; l++) {//4つの内3つあればリーチ
            if (c[0] > 5 || c[0] < 0 || c[1] > 6 || c[1] < 0 ||
              data[c[0]][c[1]] == (player % 2 + 1)) continue b;//盤外か相手がいたら終わり
            if (data[c[0]][c[1]] == 0) {//空きが1つならリーチ
              if (r) {//2つ空きがあれば終わり
                continue b;
              } else {
                r = [c[0], c[1]];
              }
            }
            c[0] += w[0];
            c[1] += w[1];
          }
          if (reach[player].indexOf(`${r[0]}${r[1]}`) == -1) {//被ってなければ追加
            reach[player].push(`${r[0]}${r[1]}`);
          }
        }
      }
    }

    const win = () => {
      //('%cWIN!!', `color:${color[player]};font-size:23px`)
      setTimeout(() => {
        alert(`WIN\n${color[player]}`);
      }, 300);
    }

    let CAN = [0, 1, 2, 3, 4, 5, 6];//置ける場所　置けない場所は消す
    const com = () => {//COM思考　　2023/5/1~
      console.clear();
      //('-----COM思考-----')

      let can = CAN.concat();//置ける場所をコピー　置いてはいけない場所も消す

      for (let i in reach[2]) {//リーチがあれば勝ち
        let r = reach[2][i].split('');
        r[0] = Number(r[0]);
        if (r[0] == 5 || data[r[0] + 1][r[1]]) {
          //('勝ち');
          put(Number(r[1]), 2);
          return;
        }
      }

      if (reach[1].length) //('相手のリーチ' + reach[1])
      for (let i in reach[1]) {//相手にリーチされていたら対処
        let r = reach[1][i].split('');
        r[0] = Number(r[0]);
        r[1] = Number(r[1]);
        if (r[0] == 5 || data[r[0] + 1][r[1]]) {//相手にリーチされていたら対処
          //('リーチつぶし');
          put(r[1], 2);
          return;
        }
        if (r[0] == 4 || data[r[0] + 2][r[1]]) {//1つ上が相手のリーチなら置かない
          can.splice(can.indexOf(r[1]), 1);
        }
      }
      if (can.length < 1) {//選択肢が1つ以下
        //('消去法');
        put(can[0] || CAN[0], 2);
        return;
      }

      // for (let i in reach[2]) {
      //   let r = reach[2][i].split('');
      //   r[0] = Number(r[0]);
      //   r[1] = Number(r[1]);
      //   if (r[0] == 4 || data[r[0] + 2][r[1]]) {//相手はCOMのリーチの下に置かない
      //     can2.splice(can.indexOf(r[1]), 1);
      //     //('相手は'+r[1]+'に置かない');
      //   }
      // }


      let MIN = [];
      let max = [-100000, null];//最高点,その場所  COMは点が1番高くなるところに置く
      for (let i in can) {//選択肢(最大7)
        let d = JSON.parse(JSON.stringify(data));
        let height_copy = put_height.concat();
        let can2 = CAN.concat();//相手視点ver
        d[height_copy[can[i]]][can[i]] = player;
        height_copy[can[i]]--;
        if (height_copy[can[i]] < 0) can2.splice(can2.indexOf(can[i]), 1);
        //(`%cもしCOMが ${can[i]} に置いたら`, "font-size:1.4em")
        let min = [100000, CAN[0]];//最低点,その場所  相手は(COM視点の)点が1番低くなるところに置く
        for (let j in can2) {
          let d2 = JSON.parse(JSON.stringify(d));
          d2[height_copy[can2[j]]][can2[j]] = 1;
          //('もし相手が', can2[j], 'に置いたら')
          let S2 = evaluate(d2, 2);
          //(S2, '点')
          if (S2 < min[0]) min = [S2, can2[j]];
        }
        //('COMが', can[i], 'に置いたら相手は', min);
        if (min[0] > max[0]) max = [min[0], can[i]];
        MIN.push(min[0]);
      }


      let m = Math.max.apply(null, MIN);
      let M = [];
      for (let i = 0; i < MIN.length; i++) {
        if (MIN[i] == m) M.push(can[i]);
      }
      //('それぞれの点数', MIN);
      let r = Math.floor(Math.random() * M.length); //(M + 'の中から' + M[r])
      put(M[r], 2);



      // let r = Math.floor(Math.random() * can.length); //(can + 'の中から' + can[r])
      // put(can[r] || CAN[0], 2);

    }

    const three_way = [[0, 1], [1, 1], [-1, 1]];//行の方向
    const start_place = [//3方向のチェックスタート位置
      [[0, 0], [1, 0], [2, 0], [3, 0], [4, 0], [5, 0]],
      [[2, 0], [1, 0], [0, 0], [0, 1], [0, 2], [0, 3]],
      [[3, 0], [4, 0], [5, 0], [5, 1], [5, 2], [5, 3]]
    ];
    const evaluate = (d, e_player) => {//盤面の評価(COM視点)  e_playerは今の手番(置可リーチがあれば勝ち)
      //('評価する\n', d);
      let score = 0;
      let v_reach = [null, [], []];//この盤面のリーチの場所
      let des = ['横', '右下がり', '右上がり'];
      let double_reach = [null, false, false];//置可ダブルリーチか上下リーチ


      for (let i = 0; i < 7; i++) {
        let line = '';
        for (let j = 5; j > -1; j--) {
          line += d[j][i];
          if (d[j][i] == 0) break;
        }
        if (line.length < 4) continue;//4つなければ次の行へ
        let p = [line.indexOf('1110'), line.indexOf('2220')];//リーチの場所
        if (p[0] != -1) {
          if (e_player == 1) return -10000;
          v_reach[1].push(`${5 - p[0] - 3}${i}`);
          v_reach[1].push(true);
        } else if (p[1] != -1) {
          if (e_player == 2) return 10000;
          v_reach[2].push(`${5 - p[1] - 3}${i}`);
          v_reach[2].push(true);
        }
      }

      for (let w in three_way) {//3方向
        let way = three_way[w];
        ////(`%c${des[w]}チェック`,"color:red;font-size:1.4em");

        c: for (let i = 0; i < 6; i++) {//1行ずつチェック
          let start = start_place[w][i];
          ////(start,'からスタート')
          let line = '';//チェックする行
          for (let j = 0; j < 7; j++) {//1行最大7マス
            let p = [start[0] + way[0] * j, start[1] + way[1] * j];
            if (p[0] == 6 || p[0] == -1 || p[1] == 7) break;
            line += d[p[0]][p[1]];
          }
          ////(des[w], 'の', line, 'をチェック')
          if (line.indexOf(1) == -1 && line.indexOf(2) == -1) continue c;//どちらもなければノーカン



          let v_reach2 = false;//この行にリーチがあったか
          for (let j = 0; j < line.length - 3; j++) {//リーチがあるか
            let L = line.slice(j, j + 4);//並んだ4つ
            if (reach_pattern.indexOf(L) != -1) {
              let z = L.indexOf('0');
              let p = `${start[0] + way[0] * (j + z)}${start[1] + way[1] * (j + z)}`;//リーチの場所
              let pl = L.indexOf('1') == -1 ? 2 : 1;//どちらのリーチか
              if (v_reach[pl].indexOf(p) == -1) {//被ってなければ

                let can_put = p[0] == 5 || !!d[Number(p[0]) + 1][p[1]];//置可か
                if (can_put && pl == e_player) {
                  return pl == 1 ? -10000 : 10000;//手番側の置可リーチがあれば終わり
                }
                v_reach[pl].push(p);
                v_reach[pl].push(can_put);
              }
              v_reach2 = true;
            }
          }

          //if(v_reach2)//('リーチがある')
          if (v_reach2) continue c;//この行にリーチがあったらもう次の行へ

          for (let j = 0; j < line.length - 3; j++) {
            L = line.slice(j, j + 4);//並んだ4つ
            let iti = L.indexOf(1) != -1;
            let ni = L.indexOf(2) != -1;
            if ((iti && ni) || (!iti && !ni)) continue;//どちらもあってもノーカン
            let chance = iti ? 1 : 2;


            ////(L , 'を調べる',j)

              let s = 0;//並んだ4つの評価
            if (L[0]!='0') s++; if (L[1]!='0') s++; if (L[2]!='0') s++; if (L[3]!='0') s++;

            score += ni ? s : -s;//COMのチャンスならプラス

          }
        }
      }

      //(v_reach)
      for (let i = 1; i < 3; i++) {
        let vr = v_reach[i];
        let n = vr.indexOf(true);

        if (n != -1) {//置可リーチがある
          vr[n] = "TRUE";
          if (vr.indexOf(true) != -1) {//置可リーチがもう1つある
            //(i, 'のダブルリーチ');
            score += i == 2 ? 1000 : -1000;
          }
          vr[n] = true;
        }

        for (let j = 0; j < vr.length; j += 2) {
          if (vr.indexOf(Number(vr[j][0]) - 1 + vr[j][1]) != -1) {//上下リーチがある
            //(i, 'の上下リーチ', vr[j])
            score += i == 2 ? 1000 : -1000;
          }
          if (!vr[j + 1]) score += i == 2 ? 10 : -10;//リーチ1つごとに10点
        }
      }

      return score;
    }




    function pu(pl, pla) {
      if (pla == 2) player = 2;
      else player = 1;
      put(pl)
    }

    function v() {
      //(evaluate(data, player));
    }






    //start_button.onclick();




//     let c=0;
// for(let i=0;i<128;i++){
//     let t = i.toString(2);
//     if(t.indexOf('1111')!=-1)continue;
//     let l=t.length;
//     for(let j=0;j<7-l;j++){
//         t='0'+t;
//     }
//     if(t.indexOf('1110')!=-1||t.indexOf('1101')!=-1||t.indexOf('1011')!=-1||t.indexOf('0111')!=-1)continue;
//     //(t);
//     c++;
// }
// //(c+'通り')

// 11 があるとないで評価法分ける

  </script>
</body>

</html>
