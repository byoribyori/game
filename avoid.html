<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>避ける</title>
  <style>
    html,
    body {
      overflow: hidden
    }

    html {
      width: 100%;
      height: 100%;
    }

    body {
      position: absolute;
      width: 100%;
      height: 100%;
      margin: 0;
    }

    #score {
      position: absolute;
      top: 3vw;
      left: 5vw;
      display: block;
      width: 90vw;
    }

    #display {
      width: 90vw;
      display: block;
      margin: 3vw auto;
      box-shadow: inset 0vw 0vw 2vw 1vw gray;
    }

    #manipulate {
      width: 90vw;
      display: flex;
      margin: auto;
    }

    #manipulate>canvas {
      width: 44vw;
      margin: auto;
      background-color: #e2e2e2;
      display: block;
    }
  </style>
</head>

<body>
  <canvas id="score" width="400" height="40"></canvas>
  <canvas id="display" width="400" height="600"></canvas>
  <div id="manipulate">
    <canvas width="200" height="60"></canvas>
    <canvas width="200" height="60"></canvas>
  </div>
  <button id="start">スタート</button>

  <script>
    /**
    * @type {HTMLCanvasElement}
    */
    const display = document.getElementById('display');
    const ctx_display = display.getContext('2d');

    const manipulate = document.getElementById('manipulate').getElementsByTagName('canvas');
    /**
    * @type {HTMLCanvasElement}
    */
    const manipulate_left = manipulate[0];
    const ctx_left = manipulate_left.getContext('2d');
    /**
    * @type {HTMLCanvasElement}
    */
    const manipulate_right = manipulate[1];
    const ctx_right = manipulate_right.getContext('2d');

    ctx_left.beginPath();//左矢印
    ctx_left.fillStyle = 'black';
    ctx_left.lineWidth = 3;
    ctx_left.moveTo(85, 5);
    ctx_left.lineTo(60, 30);
    ctx_left.lineTo(85, 55);
    ctx_left.lineTo(85, 40);
    ctx_left.lineTo(140, 40);
    ctx_left.lineTo(140, 20);
    ctx_left.lineTo(85, 20);
    ctx_left.closePath()
    ctx_left.fill();

    ctx_right.beginPath();//右矢印
    ctx_right.fillStyle = 'black';
    ctx_right.lineWidth = 3;
    ctx_right.moveTo(115, 5);
    ctx_right.lineTo(140, 30);
    ctx_right.lineTo(115, 55);
    ctx_right.lineTo(115, 40);
    ctx_right.lineTo(60, 40);
    ctx_right.lineTo(60, 20);
    ctx_right.lineTo(115, 20);
    ctx_right.closePath()
    ctx_right.fill();

    let touch = [false, false];
    manipulate_left.addEventListener('touchstart', (e) => {
      e.preventDefault()
      touch[0] = true;
    }, false);

    manipulate_left.addEventListener('touchend', (e) => {
      e.preventDefault()
      touch[0] = false;
    }, false);

    manipulate_right.addEventListener('touchstart', (e) => {
      e.preventDefault()
      touch[1] = true;
    }, false);

    manipulate_right.addEventListener('touchend', (e) => {
      e.preventDefault()
      touch[1] = false;
    }, false);

    ctx_display.font = '40px serif'
    let loop;
    let start = document.getElementById('start');
    start.addEventListener('click', () => {
      start.remove();
      let count = 0, drop = {}, drop_id = 0, playerX = 180;//（プレイヤーのYは固定）
      const type_list = [
        { color: 'red', width: 40, height: 60, speed: 7 },
        { color: 'blue', width: 40, height: 40, speed: 12 },
        { color: 'black', width: 40, height: 20, speed: 5 },
        { color: 'green', width: 40, height: 40, speed: 7 },
        { color: 'yellow', width: 40, height: 40, speed: 9 }];
      let position_list = [0, 40, 120, 160, 200, 240, 280, 320, 360];
      loop = setInterval(() => {
        //プレイヤー描画
        if (touch[0]) playerX = Math.max(playerX - 3, 0);//左がタッチされていたら左に動かす
        if (touch[1]) playerX = Math.min(playerX + 3, 360);;//右がタッチされていたら右に動かす
        ctx_display.clearRect(0, 0, 400, 600);
        ctx_display.beginPath();
        ctx_display.strokeStyle = 'black';
        ctx_display.lineWidth = 2;
        ctx_display.arc(playerX + 20, 520, 15, 0, 2 * Math.PI, false);//頭
        ctx_display.moveTo(playerX + 20, 535);
        ctx_display.lineTo(playerX + 20, 570);//胴体
        ctx_display.lineTo(playerX + 3, 590);//足
        ctx_display.moveTo(playerX + 20, 570);
        ctx_display.lineTo(playerX + 37, 590);//足
        ctx_display.moveTo(playerX + 20, 555);
        ctx_display.lineTo(playerX, 545);//手
        ctx_display.moveTo(playerX + 20, 555);
        ctx_display.lineTo(playerX + 40, 545);//手
        ctx_display.stroke();

        for (let i in drop) {
          const d = drop[i];
          const type = d.type;
          const this_block = type_list[type];
          d.y += this_block.speed;
          if (d.y < 600) {
            ctx_display.fillStyle = this_block.color;
            ctx_display.fillRect(d.x, d.y, this_block.width, this_block.height);
            // ctx_display.fillText(i, d.x, d.y)
            if (d.y >= 505 - this_block.height && d.y < 590 && d.x + this_block.width > playerX && d.x < playerX + 40) {//プレイヤーと重なっている
              delete drop[i];
              position_list.push(d.x);
              console.log('%cあたった', `color:${d.color}`)
            }
          } else {//下まで落ちたら消す
            delete drop[i];
            position_list.push(d.x);
          }
        }

        count = count % 100 + 1;
        if (count % 20 == 0) {//20ループに1度新たに落とす
          const t = Math.random() > 0.1 ? drop_id % 4 : 4;//ブロックのタイプ
          const r = Math.floor(Math.random() * position_list.length);//位置ランダム
          drop[drop_id] = {
            type: t,
            x: position_list[r],
            y: -type_list[t].height,
          };
          drop_id++;
          position_list.splice(r, 1);
        }
      }, 50);
    })


  </script>
</body>

</html>
