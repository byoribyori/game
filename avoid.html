<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>避ける</title>
  <style>
    html,
    body {
      overflow: hidden
    }

    html {
      width: 100%;
      height: 100%;
    }

    body {
      position: absolute;
      width: 100%;
      height: 100%;
      margin: 0;
    }

    #scoreAndHP {
      position: absolute;
      top: 3vw;
      left: 5vw;
      display: block;
      width: 90vw;
    }

    #display {
      width: 90vw;
      display: block;
      margin: 3vw auto;
      box-shadow: inset 0vw 0vw 2vw 1vw gray;
      transition: background-color 1s;
    }

    #manipulate {
      width: 90vw;
      display: flex;
      margin: auto;
    }

    #manipulate>canvas {
      width: 44vw;
      margin: auto;
      background-color: #e2e2e2;
      display: block;
    }

    #font>span {
      color: transparent;
    }
  </style>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tektur:wght@500&display=swap" rel="stylesheet">
</head>

<body>
  <canvas id="scoreAndHP" width="400" height="50"></canvas>
  <canvas id="display" width="400" height="600"></canvas>
  <div id="manipulate">
    <canvas width="200" height="60"></canvas>
    <canvas width="200" height="60"></canvas>
  </div>
  <button id="start">スタート</button>
  <div id="font"><span style="font-family: Tektur;">s1</span></div>

  <script>
    /**
    * @type {HTMLCanvasElement}
    */
    const display = document.getElementById('display');
    const ctx_display = display.getContext('2d');

    /**
    * @type {HTMLCanvasElement}
    */
    const scoreAndHPa = document.getElementById('scoreAndHP');
    const ctx_sl = scoreAndHP.getContext('2d');

    const manipulate = document.getElementById('manipulate').getElementsByTagName('canvas');
    /**
    * @type {HTMLCanvasElement}
    */
    const manipulate_left = manipulate[0];
    const ctx_left = manipulate_left.getContext('2d');
    /**
    * @type {HTMLCanvasElement}
    */
    const manipulate_right = manipulate[1];
    const ctx_right = manipulate_right.getContext('2d');

    ctx_left.beginPath();//左矢印
    ctx_left.fillStyle = 'black';
    ctx_left.lineWidth = 3;
    ctx_left.moveTo(85, 5);
    ctx_left.lineTo(60, 30);
    ctx_left.lineTo(85, 55);
    ctx_left.lineTo(85, 40);
    ctx_left.lineTo(140, 40);
    ctx_left.lineTo(140, 20);
    ctx_left.lineTo(85, 20);
    ctx_left.closePath()
    ctx_left.fill();

    ctx_right.beginPath();//右矢印
    ctx_right.fillStyle = 'black';
    ctx_right.lineWidth = 3;
    ctx_right.moveTo(115, 5);
    ctx_right.lineTo(140, 30);
    ctx_right.lineTo(115, 55);
    ctx_right.lineTo(115, 40);
    ctx_right.lineTo(60, 40);
    ctx_right.lineTo(60, 20);
    ctx_right.lineTo(115, 20);
    ctx_right.closePath()
    ctx_right.fill();

    let loop;
    let start = document.getElementById('start');
    start.addEventListener('click', () => {
      start.remove();
      document.getElementById('font').remove();

      let touch = [false, false];
      manipulate_left.addEventListener('touchstart', (e) => {
        e.preventDefault()
        touch[0] = true;
      }, false);

      manipulate_left.addEventListener('touchend', (e) => {
        e.preventDefault()
        touch[0] = false;
      }, false);

      manipulate_right.addEventListener('touchstart', (e) => {
        e.preventDefault()
        touch[1] = true;
      }, false);

      manipulate_right.addEventListener('touchend', (e) => {
        e.preventDefault()
        touch[1] = false;
      }, false);

      let score = 0;
      ctx_sl.font = '30px Tektur';
      ctx_sl.textBaseline = 'top';
      ctx_sl.strokeStyle = 'black';
      ctx_sl.lineWidth = 2;
      function score_update(s) {
        score += s;
        ctx_sl.clearRect(0, 0, 200, 50);
        ctx_sl.fillStyle = 'black';
        ctx_sl.fillText('SCORE ' + score, 15, 15);//スコア描画
      }
      function hp_update(l) {
        playerHP = Math.min(5, playerHP + l);//最大5
        ctx_sl.clearRect(200, 0, 200, 50);
        ctx_sl.fillStyle = 'black';
        ctx_sl.fillText('HP', 210, 15);
        ctx_sl.fillStyle = 'lightgreen';
        ctx_sl.fillRect(255, 15, Math.max(0, playerHP * 24), 25);//HP描画
        ctx_sl.strokeRect(255, 15, 120, 25);
      }

      ctx_display.strokeStyle = 'black';
      ctx_display.lineWidth = 2;
      let count = 0, drop = {}, drop_id = 0;
      let playerHP = 5, playerX = 180;//（プレイヤーのYは固定）
      let speedup = 1;
      const type_list = [
        { color: 'blue', width: 40, height: 40, speed: 13 },//速い　弱い
        { color: 'red', width: 40, height: 60, speed: 7 },//基本
        { color: 'black', width: 40, height: 20, speed: 5 },//遅い　強い
        { color: 'green', width: 40, height: 40, speed: 9 },//触ると得点
        { color: 'yellow', width: 40, height: 40, speed: 11 },//ボーナス
        { color: 'pink', width: 40, height: 40, speed: 11 }//回復
      ];
      let position_list = [0, 40, 120, 160, 200, 240, 280, 320, 360];
      const random_block = [0, 0, 1, 1, 2];
      score_update(0);
      hp_update(0);
      loop = setInterval(() => {
        //プレイヤー描画
        if (touch[0]) playerX = Math.max(playerX - 4 * speedup, 0);//左がタッチされていたら左に動かす
        if (touch[1]) playerX = Math.min(playerX + 4 * speedup, 360);;//右がタッチされていたら右に動かす
        ctx_display.fillStyle = 'black';
        ctx_display.clearRect(0, 0, 400, 600);
        ctx_display.beginPath();
        ctx_display.arc(playerX + 20, 520, 15, 0, 2 * Math.PI, false);//頭
        ctx_display.moveTo(playerX + 20, 535);
        ctx_display.lineTo(playerX + 20, 570);//胴体
        ctx_display.lineTo(playerX + 3, 590);//足
        ctx_display.moveTo(playerX + 20, 570);
        ctx_display.lineTo(playerX + 37, 590);//足
        ctx_display.moveTo(playerX + 20, 555);
        ctx_display.lineTo(playerX, 545);//手
        ctx_display.moveTo(playerX + 20, 555);
        ctx_display.lineTo(playerX + 40, 545);//手
        ctx_display.stroke();

        for (let i in drop) {//ブロック描画
          const d = drop[i];
          const type = d.type;
          const this_block = type_list[type];
          d.y += this_block.speed;
          if (d.y < 600) {
            ctx_display.fillStyle = this_block.color;
            if (type == 5) {
              ctx_display.beginPath();
              ctx_display.arc(d.x + 20, d.y + 20, 20, 0, 2 * Math.PI, false);
              ctx_display.fill();
            }
            else ctx_display.fillRect(d.x, d.y, this_block.width, this_block.height);
            if (d.y + this_block.height > 505 && d.y < 590 &&
              d.x + this_block.width > playerX && d.x < playerX + 40) {//プレイヤーと重なっている
              delete drop[i];
              position_list.push(d.x);
              console.log('%cあたった', `color:${this_block.color}`)
              if (speedup == 2) {//ボーナスタイム中
                if (type == 3) score_update(2);//緑は当たったら得点
              } else if (type < 3) {//当たってしまった
                hp_update(-type - 1)
              }
              else if (type == 3) score_update(2);//緑は当たったら得点
              else if (type == 4) {//黄色に当たったらボーナスタイム
                speedup = 2;
                ctx_display.lineWidth = 3;
                ctx_display.strokeStyle = 'yellow';
                display.style.backgroundColor = 'darkgray';
                setTimeout(() => {
                  speedup = 1;
                  ctx_display.lineWidth = 2;
                  ctx_display.strokeStyle = 'black';
                  display.style.backgroundColor = '';
                }, 10000);
              } else {//ピンクは回復
                hp_update(1);
              }
            }
          } else {//下まで落ちたら消す
            delete drop[i];
            position_list.push(d.x);
            if (type < 3) score_update(1);
          }
        }

        ctx_display.clearRect(0, 0, 400, 50);//スコア表示の場所確保

        if (playerHP < 1) gameover();

        count = count % 300 + 1;
        if (count % 15 == 0) {//15ループに1度新たに落とす
          //5回に1回は緑 低確率で黄、ピンク それ以外ランダム
          const t = drop_id % 5 == 3 ? 3 : Math.random() < 0.03 && speedup == 1 ? 4 :
            Math.random() < 0.03 ? 5 : random_block[Math.floor(Math.random() * 5)];
          const r = Math.floor(Math.random() * position_list.length);//位置ランダム
          drop[drop_id] = {
            type: t,
            x: position_list[r],
            y: -type_list[t].height,
          };
          drop_id++;
          position_list.splice(r, 1);
        }
      }, 50);

      function gameover() {
        clearInterval(loop);
        ctx_display.fillStyle = 'white';
        ctx_display.strokeStyle = 'black';
        ctx_display.font = '70px Tektur';
        const text = 'GAMEOVER';
        const margin = 200 - ctx_display.measureText(text).width / 2;
        ctx_display.fillText(text, margin, 300);
        ctx_display.strokeText(text, margin, 300);
      }
    });


  </script>
</body>

</html>
